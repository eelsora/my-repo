# 18. 웹 호스팅

콘텐츠 리소스를 저장, 중개, 관리하는 일을 통틀어 웹 호스팅이라 한다. 호스팅은 웹 서버의 갖아 중요한 기능 중 하나다.

호스팅 업체는 서버와 웹 사이트 관리 프로그램을 대여해주고 다양한 등급의 보안, 리포트, 사용 편의를 제공한다.

## 18.1 호스팅 서비스

웹 초기에는 각 회사가 자체 컴퓨터 하드웨어를 구매하고 자체 컴퓨터망을 구축하며, 네트워크 연결을 확보하고 웹 서버 소프트웨어를 관리했다.

웹이 빠르게 대세가 되며 이들을 관리하기 위한 기술과 시간을 가진 사람은 드물었고, 그 시간을 절약하기 위해 이들을 전문적으로 관리할 수 있도록 하는 웹 호스팅 서비스 제공 신사업이 만들어지게 되었다.

웹 호스팅은 물리적인 장비관리에서 부터 고객이 직접 콘텐츠를 제공할 수 있도록 하는 총체적인 호스팅까지 다양한 서비스를 제공한다.

### 18.1.1 간단한예: 전용 호스팅

- **인터넷 서비스 제공자 (Internet Service Provider, ISP)**
  - 개인이 인터넷에 접속하고 인터넷 서비스를 이용할 수 있도록 해주는 사업자
  - 광대역 통신망을 통해 고객에게 인터넷 접속을 제공하고, 이메일, 웹 호스팅 등의 부가 서비스도 제공

## 18.2 가상 호스팅

많은 웹 호스팅 업자는 컴퓨터 한대를 여러고객이 공유하게 해서 저렴한 웹 호스팅 서비스를 제공한다. 이를 공유 호스팅 혹은 가상 호스팅이라 부른다.

각 웹 사이트는 다른 서버에서 호스팅 하는것처럼 보이겠지만, 사실은 물리적으로 같은 서버에서 호스팅되는 것이다. 최종 사용자의 관점에서 가상 호스팅에 있는 웹 사이트는, 물리적으로 분리된 전용 서버에서 호스팅 하는 사이트와 구분할 수 없어야한다.

### 18.2.1 호스트 정보가 없는 가상 서버 요청

HTTP/1.0명세는 공용 웹 서버가 호스팅하고 있는 가상 웹 사이트에 누가 접근하고 있는지 식별하는 지능을 제공하지 않는다.

HTTP/1.0 요청은 호스트명에 대한 별 다른 언급 없이 `GET /index.html` 이라는 요청만 하기 떄문에 서버가 여러 개의 사이트를 가상 호스팅 하고 있으면, 사용자가 어떤 가상 웹사이트로 접근하려고 하는지 정보가 충분하지 않다. (HTTP/1.1 은 이 문제를 해결하려고 Host헤더를 지원한다)

### 18.2.2 가상 호스팅 동작하게 하기

HTTP/1.1을 지원하는 서버는 HTTP 요청 메세지에 있는 전체 URL을 처리할 수 있어야한다.

- URL 경로를 통한 가상 호스팅
  - 서버가 어떤 사이트를 요청하는 것인지 알 수 있게 URL에 특별한 경로 컴포넌트를 추가한다.
  - 일반적으로 URL기반 가상호스팅은 좋은 방법이지 않아 거의 사용하지 않음
- 포트 번호를 통한 가상 호스팅
  - 각 사이트에 다른 포트번호를 할당하여, 분리된 웹 서버의 인스턴스가 요청을 처리한다.
  - 사용자는 URL에 비표준 포트를 쓰지 않고서도 리소스를 찾기 원한다.
- IP 주소를 통한 가상 호스팅
  - 각 가상 사이트에 별도의 IP 주소를 할당하고 모든 IP주소를 장비 하나에 연결한다. 웹 서벙는 IP 주소로 사이트 이름을 식별한다.
  - 가상 IP를 할당하여 서버는 HTTP 커넥션의 목적지 IP주소를 보고 클라이언트가 어떤 웹 사이트에 연결하려고 하는지 알 수 있다.
  - 가상IP 호스팅은 잘 동작하지만, 규모가 아주 큰 호스팅 업자에게는 약간 어려운 문제를 안겨준다.
  - 일반적으로 컴퓨터 시스템이 연결할 수 있는 장비 IP의 개수가 제한이 있음
  - IP 주소는 희소 상품이기 때문에 가상 사이트를 ㄹ아주 많이 갖게될 경우 모든 웹사이트에 할당할 IP주소가 충분하지 못하다.
  - IP 주소가 부족한 문제는 호스팅 업자가 용량을 늘리려고 서버를 복제하면 더욱 심각해진다. 부하 균형의 구조상, 각 복제된 서버에 IP주소를 부여햐애햐 하므로 IP주소는 복제 서버의 개수만큼 더 필요해진다.
- Host 헤더를 통한 가상 호스팅
  - 많은 웹 호스팅 업자들은 HTTP 설계자에게 이 문제를 해결해달라는 압력을 넣었다. HTTP/1.0의 개선버전과 HTTP/1.1의 공식 버전은 사이트 이름을 알려주는 Host헤더에 정의했다. 웹 서버는 Host 헤더로 가상 사이트를 식별할 수 있다.

### 18.2.3 HTTP/1.1 Host 헤더

Host헤더는 RFC2068에 정의되어있는 HTTP/1.1요청헤더다. 가상 서버는 매우 흔하기 때문에 대부분의 HTTP클라이언트가 HTTP/1.1과 호환되지 않더라도 Host헤더는 구현한다.

- **문법과 사용 방법**
  - Host헤더에는 원본 URL에 있는 요청 리소스에 대한 인터넷 호스트와 포트번호를 기술한다.
  - `Host = “Host” “:” 호스트 [ “:” 포트]`
  - **규칙**
    - Host헤더에 포트가 기술되어있지 않으면 해당 스킴의 기본 포트를 사용해야한다.
    - URL에 IP주소가 있으면 Host헤더는 같은 주소를 포함해야한다.
    - URL에 호스트명이 기술되어있으면 Host헤더는 같은 호스트명을 포함해야한다.
    - URL에 호스트명이 기술되어있으면 Host헤더는 URL의 호스트명이 가리키는 IP주소를 포함해서는 안된다. 그 이유는 여러개의 가상 사이트를 한 개의 IP 주소에 연결한 가상 호스트 서버에서 문제가 될 수 있기 때문
    - 클라이언트가 특정 프락시 서버를 사용해야 한다면 Host헤더 프락시 서버가 아닌 원 서버의 호스트명과 포트를 기술해야한다. 과거에는 여러 웹 클라이언트가 프락시 설정이 활성화 되어있을 때 전송하는 Host헤더에 프락시의 호스트명을 넣는 버그가 있었다. 이는 프락시와 원 서버를 오동작 시키는 원인이 된다.
    - 웹 클라이언트는 모든 요청 메세지에 Host헤더를 기술해야한다.
    - 웹 프락시는 요청을 전달하기 전에 요청 메세지에 Host헤더를 추가해야한다.
    - HTTP/1.1 웹 서버는 Host헤더 필드가 없는 HTTP/1.1 요청 메세지를 받으면 400 상태코드로 응답해야한다.
- **Host 헤더의 누락**
  - 서버는 사용자를 기본 웹 페이지로 보내거나 브라우저를 업그레이드하라고 제안하는 에러 페이지를 반환할 수 있다.
- **Host 헤더 해석하기**
  - HTTP 요청 메세지에 전체 URL(스킴과 호스트 컴포넌트가 기술)이 기술되어있으면 Host헤더에 있는 값은 무시하고 URL을 사용한다.
  - HTTP 요청 메세지에 있는 URL에 호스트 명이 기술되어있지 않고 요청에 Host헤더가 있으면 호스트 명과 포트를 Host헤더에서 가져온다.
  - 1단계나 2단계에서 호스트를 결정할 수 없으면 클라이언트에 400 반환
- **Host 헤더와 프락시**
  - 어떤 브라우저는 부정확한 헤더를 보낸다

## 18.3 안정적인 웹 사이트 만들기

웹사이트 장애가 생기는 몇가지 상황은 서버다운, 트래픽 폭증, 네트워크 장애나 손실 등이 있다.

### 18.3.1 미러링된 서버 팜

서버팜은 서로 대신할 수 있고 식별할 수 있게 설정된 웹 서버들ㄹ의 집합이다. 서버 팜의 서버에 있는 콘텐츠들은 한 곳에 문제가 생기면 다른 한 곳에서 대신 전달할 수 있게 미러링 할 수 있다.

- **HTTP 리다이렉션**
  - 콘텐츠에 대한 URL은 마스터 서버의 IP를 가리키고, 마스터서버는 요청을 받는 즉시 복제 서버로 리다이렉트 시킨다.
- **DNS 리다이렉션**
  - 콘텐츠의 URL은 네 개의 IP 주소를 가리킬 수 있고 DNS 서버는 클라이언트에게 전송할 IP 주소를 선택할 수 있다.

### 18.3.2 콘텐츠 분산 네트워크(CDN)

특정 컨텐츠의 분산을 목적으로 하는 단순한 네트워크이다. 네트워크의 노드는 서버, 대리서버, 혹은 프락시 서버가 될 수 있다.

### 18.3.3 CDN의 대리 캐시

대리캐시는 복제 원 서버를 대신해 사용될 수 있다. 리버스 프락시라고도 불리는 대리서버는 미러링 된 웹 서버처럼 콘텐츠에 대한 요청을 받는다. 그들은 특정 원 서버 집합을 대신해 요청을 받는다.

대리서버와 미러링된 서버의 차이는 대리서버는 보통 수요에 따라 동작한다는 것이다. 대리 서버는 원 서버의 전체 컨텐츠를 복사하지는 않는다. 클라이언트가 요청하는 콘텐츠만 저장할 뿐이다. 대리 서버의 캐시에 콘텐츠가 분산되는 방식은 그들이 받는 요청에 따라 달라진다. 원 서버는 그들의 콘텐츠를 업데이트 해줄 의무는 없다. 많은 요청이 있는 콘텐츨를 빠르게 제공하려고 사용자가 요청하기도 전에 가져오는 미리 가져오기 기능을 가진 대리 서버도 있으며 CDN이 이 대리서버보다 캐시를 계층화하기 어렵다.

### 18.3.4 CDN의 프락시 캐시

대리 서버와는 다르게 전통적인 프락시 캐시는 어떤 웹 서버 요청이든 다 받을 수 있다.

대리서버를 사용하면 프락시 캐시의 콘텐츠는 요청이 있을 때만 저장될 것이고 원본 서버 콘텐츠를 정확히 복제한다는 보장이 없다. 어떤 프락시는 요청을 많이 받는 콘텐츠를 미리 로딩하기도 한다.

요청이 있을때만 저장하는 프락시 캐시는 스위치나 라우터가 중간에서 웹 트래픽을 가로채 처리 하기도 한다.

## 18.4 웹 사이트 빠르게 만들기

서버 팜이나 분산 프락시 캐시나 대리서버는 혼잡을 조절ㄹ하고 네트워크 트래픽을 분산시켜 서버에서 클라이언트로 전송하는 시간을 단축시켜준다. 리소스 로딩 속도를 좌우하는 핵심은 어떻게 요청과 응답이 클라이언트 와 서버 사이에서 연결를 맺고 가로질러 데이터를 전송하는지이다.

웹사이트 속도를 높이는 또 다른 접근 방법은 콘텐츠를 인코딩 하는 것이다. 예를 들면 클ㄹ라이언트가 받은 압축을 해제할 수 있다는 가정 하에 콘틴츠를 압축하는 것이다.
