# 17. 내용 협상과 트랜스코딩

트랜스코딩은 HTTP 클라이언트와 서버 사이의 내용 협상에 대한 응답에서 수행된다.

## 17.1 내용 협상 기법

1. **클라이언트 주도**: 클라언트가 요청을 보내면, 서버는 클라이언트에게 선택지를 보내주고, 클라이언트가 선택한다.
   - 장점: 서버 입장에서 구현하기 가장 쉬움. 클라이언트는 최선의 선택을 할 수 있음.
   - 단점: 대기시간이 증가함. 올바른 컨텐츠를 얻으려면 최소 두번의 요청이 필요함
2. **서버 주도**: 서버가 클라이언트의 요청헤더를 검증해서 어떤 버전을 제공할지 결정한다.
   - 장점: 클라이언트 주도 협상보다 빠름. HTTP는 서버가 가장 적절한 것을 선택할 수 있도록 q값 메커니즘을 제공하고, 서버가 다운스트림 장치에게 요청이 어떻게 평가되는지 말해줄 수 있도록 하기 위해 Vary헤더를 제공한다.
   - 단점: 만약 결정이 뻔하지 않으면(헤더에 맞는것이 없으면) 서버는 추측을 해야한다.
3. **투명:** 투명한 중간 장치(주로 프락시 캐시)가 서버를 대신하여 협상을 한다.
   - 장점: 웹 서버가 협상을 할 필요가 없다. 클라이언트 주도 협상보다 빠르다.
   - 단점: 투명 협상을 어떻게 하는지에대한 정형화된 명세가 없다.

## 17.2 클라이언트 주도 협상

클라이언트에게 줄 선택지를 표현하는 방법에는 두가지가 있다.

여러가지 버전에 대한 링크와 각각에 대한 설명이 담긴 HTML 페이지를 돌려주거나, 300 Multiple Choices 응답코드로 HTTP/1.1 응답을 돌려주는 것이다. 첫번째 메서드의 결과로, 클라이언트 브라우저는 이러한 응답을 받아 링크와 함께 페이지를 보여주거나, 사용자가 결정하도록 하기 위해 대화창을 띄울것이다. 이 경우 결정은 브라우저 사용자에 의해 수동으로 클라이언트 쪽에서 행해진다.

## 17.3 서버 주도 협상

클라이언트와 추가 커뮤니케이션을 줄이기 위한 방법으로는 클라이언트가 반드시 자신이 무엇을 선호하는지 충분한 정보를 주어 서버가 현명한 결정을 할 수 있게 해주는 것이다. 서버는 이 정보를 클라이언트의 요청 헤더에서 얻는다.

HTTP서버가 클라이언트에게 보내줄 적절한 응답을 계산하기 위해 사용하는 메커니즘은 두 가지이다.

- 내용 협상 헤더들을 살펴본다. 서버는 클라이언트의 Accept관련 헤더들을 보고 그에 알맞는 응답 헤더를 준비한다.
- 내용 협상 헤더 외의 다른 헤더들을 살펴본다. 예를들어, 서버는 클라이언트의 User-Agent 헤더에 기반하여 응답을 보내줄 수도 있다.

### 17.3.1 내용 협상 헤더

서버는 클라이언트의 Accept 관련 헤더들을 적절한 엔터티 헤더들과 짝을 지어준다. HTTP는 상태가 없는 프로토콜이기 때문에, 클라이언트는 자신의 선호 정보를 반드시 매 요청마다 보내야한다.

- **Accept**
  - 서버가 어떤 미디어 타입으로 보내도 되는지 알려준다.
  - 엔터티 헤더: **Content-Type**
- **Accept-Language**
  - 서버가 어떤 언어로 보내도 되는지 알려준다.
  - 엔터티 헤더: **Content-Language**
- **Accept-Charset**
  - 서버가 어떤 차셋으로 보내도 되는지 알려준다.
  - 엔터티 헤더: **Content-Type**
- **Accept-Encoding**
  - 서버가 어떤 인코딩으로 보내도 되는지 알려준다.
  - 엔터티 헤더: **Content-Encoding**

### 17.3.2 내용 협상 헤더의 품질값

HTTP 프로토콜은 클라이언트가 각 선호의 카테고리마다 여러 선택 가능한 항목을 선호도와 함께 나열할 수 있도록 품질값을 정의하였다.

`Accept-Language: en;q-0.5, fr;q=0.0, nl;q=1.0, tr;q=0.0`

→ 클라이언트가 네덜란드어 문서를 받기 원하나 영어로된 문서라도 받아들일 것을 의미함. 프랑스어, 터키어는 원하지 않음

(0.0(가장 낮은)~1.0까지의 값으로 선호도를 의미한다.)

### 17.3.3 그 외의 헤더들에 의해 결정

서버는 User-Agent와 같은 클라이언트의 다른 요청 헤더들을 이용해 알맞은 요청을 만들어내려고 시도할 수 있다.

캐시는 반드시 캐시된 문서의 올바른 ‘최선의’버전을 제공해주려 해야하기 때문에 HTTP프로토콜은 서버가 응답에 넣어 보낼 수 있는 Vary헤더를 정의한다.

### 17.3.4 아파치의 내용 협상

- **type-map 파일 사용하기**
  - 웹사트이의 디렉터리에서, variant를 갖는 웹사이트의 각 URI를 위한 type-map 파일을 만든다. 그 type-map 파일은 모든 배리언트와 그들 각각에 대응하는 내용 협상 헤더들을 나열한다.
  - `AddHandler type-map .var`
    → 이 줄은 .var 확장자를 가진 파일들이 type-map 파일임을 의미한다.
- **MultiViews 사용하기**
  - 아파치가 그 디렉터리에 대해 자동으로 type-map 파일을 생성하도록 하는 Multiviews 지시어를 켠다.

### 17.3.5 서버 측 확장

서버에서 내용 협상을 구현하는 방법으로, 마이크로소프트의 액티브 서버페이지(ASP)와 같이 서버쪽에서 확장을 하는 방법이 있다.

## 17.4 투명 협상

클라이언트 입장에서 협상하는 중개자 프락시를 둠으로써 클라이언트와의 메세지 교환을 최소화하는 동시에 서버 주도 협상으로 인한 부하를 서버에서 제거한다. 서버는 응답에 Vary헤더를 포함시켜 보냄으로써 중개자에게 내용 협상을 위해 어떤 헤더를 사용하고 있는지 알려줄 수 있다.

### 17.4.1 캐시와 얼터네이트(alternate)

캐시는 첫번째, 두번째 요청 그대로 서버에 전달하고 그 URL에 대한 응답들을 모두 저장해야한다. 서버와 마찬가지로 캐시는 같은 URL에 대해 여러 문서를 갖게 된다. 이 다른 버전은 배리언트나 얼터네이트로 불린다.

내용 협상은 variant중에서 클라이언트의 요청에 가장 잘 맞는 것을 선택하는 과정으로 이해될 수 있다.

### 17.4.2 Vary 헤더

HTTP Vary 응답 헤더는 서버가 문서를 선택하거나 커스텀 콘텐츠를 생성할 때 고려한 클라이언트 요청 헤더 모두를 나열한다.

새 요청이 도착했을 때, 캐시는 내용 협상 헤더들을 이용해 가장 알맞는것을 찾고 캐시는 반드시 Vary헤더가 있는지 확인해야한다. 존재한다면 Vary헤더가 명시하고 있는 헤더들은 새요청과 오래된 캐시 요청에서 그 값이 서로 맞아야한다. 왜냐하면 서버는 클라이언트의 요청 헤더에 따라 그들의 응답이 달라질 수 있기 때문에 투명 협상을 구현하기 위해 캐시는 반드시 캐시된 배리언트와 함께 클라이언트 요청헤더와 그에 알맞는 서버 응답 헤더 양쪽 모두를 저장해야한다.

## 17.5 트랜스코딩

서버가 클라이언트의 요구에 맞는 문서를 아예 갖고있지 않는다면 서버는 에러로 응답해야겠지만, 이론적으로 서버는 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환할 수도 있다. 이를 트랜스코딩이라 부른다. 트랜스 코딩에는 포맷변환, 정보합성, 내용 주입의 세 종류가 있다.

- 가상의 트랜스코딩
  - HTML 문서 → WML문서
  - 고해상도 이미지 → 저해상도이미지
  - 64K색 이미지 → 흑백이미지
  - 프레임을 포함한 복잡한 페이지 → 프레임이나 이미지가 없는 단순한 테스트 페이지

### 17.5.1 포맷 변환

포맷 변환은 데이터를 클라이언트가 볼 수 있도록 한 포맷에서 다른 포맷으로 변환하는 것이다. 이는 인코딩이나 전송 인코딩과는 다르다. 트랜스 코딩은 콘텐츠를 특정 접근 장치에서 볼 수 있도록 하기 위한 것이고, 후자는 보통 콘텐츠의 효율적이고 안전한 전송을 위한 것이다.

### 17.5.2 정보 합성

문서에서 정보의 요점을 추출하는 것을 정보합성(information synthesis)라고 하는데 이는 트랜스 코딩 과정에서 유용할 수 있다. 간단한 예로는 각 절의 제목에 기반한 문서의 개요 생성이나 페이지에서 광고 및 로고 제거를 들 수 있다.

### 17.5.3 콘텐츠 주입

이는 또 다른 종류의 변환인 내용 주입 트랜스코딩이며 예를 들면 자동광고 생성과 사용자 추적 시스템이 있다. 특정 사용자를 대상으로 하는 광고를 그때그때 동적으로 삽입하고, 클라이언트가 어떻게 웹을 돌아다니는지에 대한 통계를 수집하기 위해 페이지에 동적으로 콘텐츠를 추가할 수 있도록 만들어져있다.

### 17.5.4 트랜스코딩 vs 정적으로 미리 생성해놓기

트랜스코딩의 대안은 웹서버에서 웹 페이지의 여러가지 사본을 만드는것이다.하지만 몇몇 트랜스 코딩은 정적인 방법으로는 수행될 수 없다. 사용자에 따라 어떤 광고가 삽입될지는 그때마다 필요할 때 변환해야한다. 하지만 이는 콘텐츠 제공에 있어 대기시간 증가로 인한 비용을 초래할 수 있다. 이를 위해 제 삼자에게 수행하게 하여 웹 서버의 부담을 덜 수도 있다. 변환은 더 싼 프락시나 캐시에 있는 외부 에이전트에 의해 수행될 수 있다.

## 17.6 다음 단계

- HTTP의 내용 협상은 성능 제약을 초래한다.
- HTTP는 내용 협상이 필요한 유일한 프로토콜이 아니다.
