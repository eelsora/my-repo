# 20. 리다이렉션과 부하균형

리다이렉션 기술은 보통 메시지가 프락시, 캐시, 서버 팜의 특정 웹 서버 중 어디에서 끝나는지 판별하기 위해 사용된다.

리다이렉션 기술은 클라이언트 메세지를 명시적으로 요청하지 않은 곳으로 보낼 수 있다.

- HTTP 리다이렉션
- DNS 리다이렉션
- 임의 캐스트 라우팅
- 정책 라우팅
- 아이피 맥 포워딩
- 아이피 주소 포워딩
- 웹 캐시 조직 프로토콜(WCCP)
- 인터캐시 커뮤니케이션 프로토콜(ICP)
- 하이퍼텍스트 캐싱 프로토콜(HTCP)
- 네트워크 요소 제어 프로토콜(NECP)
- 캐시 배열 라우팅 프로토콜(CARP)
- 웹 프락시 자동발견 프로토콜(WPAD)

## 20.1 왜 리다이렉트인가?

HTTP 애플리케이션은 언제나 다음 세가지를 원하기 때문에 웹 컨텐츠는 흔히 여러 장소에 배포된다.

- 신뢰할 수 있는 HTTP 트랜잭션의 수행
- 지연 최소화
- 네트워크 대역폭 절약

이렇게 하면 한곳에서 실패한 경우 다른 곳을 이용할 수 있으므로 신뢰성이 개선된다. 또한 클라이언트가 가까운 리소스에 접근할 수 있어 콘텐츠를 빨리 받게 되므로 응답시간도 줄여준다. 그리고 목적지 서버가 분산되므로 네트워크 혼잡도도 줄어든다.

## 20.2 리다이렉트 할 곳

서버, 프락시, 캐시, 게이트웨이가 모두 공통적으로 서버의 특성을 갖고 있기 때문에, 많은 리다이렉션 기법이 그들 모두에게서 동작한다.

웹 서버는 IP별로 요청을 다룬다. 똑같이 복제된 서버들로 요청을 분산한다는 것은 같은 URL에 대해 여러곳에서 온 요청들을 각각 최적의 웹 서버로 보내겠다는 것을 의미한다.

프락시는 프로토콜별로 요청을 다룬다. 이상적으로 프락시 이웃의 모든 HTTP 트래픽은 프락시를 거쳐야한다. 예를 들어 클라이언트 근처에 프락시 캐시가 있다면, 모든 요청이 프락시 캐시로 흘러들어가는 것이 이상적이다. 왜냐하면 캐시는 자주 찾는 문서를 저장하여 클라이언트에게 직접 전달 제공하기 때문에 원 서버로의 더 오래걸리고 비용이 드는 통신을 피할 수 있기 때문이다.

## 20.3 리다이렉션 프로토콜의 개요

리다이렉션의 목표는 HTTP 메세지를 가용한 웹 서버로 가급적 빨리 보내는 것이다. HTTP 메세지가 인터넷을 통해 나아가는 방향은 그 메세지가 오고, 거쳐가고, 향하는 HTTP 애플리케이션과 라우팅 장치에 영향을 받는다.

- 브라우저 애플리케이션의 사용자는 브라우저가 클라이언트 메세지를 프락시 서버로 보내도록 설정할 수 있다.
- DNS분석자(DNS resolver)는 메세지의 주소를 지정할 때 사용될 아이피 주소를 선택한다. 이 아이피 주소는 클라이언트의 지리적 위치에 따라 달라질 수 있다.
- 메세지는 주소가 지정된 여러개의 패킷으로 나뉘어 네트워크를 통과한다. 스위치와 라우터들은 패킷의 TCP/IP 주소를 검증하고 그에 근거하여 패킷을 어떻게 라우팅 할 것인지 결정한다.
- 웹서버는 HTTP 리다이렉트를 이용해 요청이 다른 웹 서버로 가도록 할 수 있다

| 매커니즘              | 어떻게 동작하나                                                                                                                                                                                                | 재 라우팅의 근거                                                           | 제약사항                                                                                                                                                                |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| HTTP 리다이렉션       | 우선 HTTP 요청은 콘텐츠를 제공하기에 최적인 웹 서버를 선택해줄 첫번째 웹 서버로 간다. 그 웹 서버는 클라이언트에게 선택한 서버로의 HTTP 리다이렉트를 보내준다. 클라이언트는 선택된 서버에게 다시 요청을 보낸다. | 라운드로빈 부하균형, 회전지연 최소화, 최단거리 선정 등의 여러 옵션들       | 느릴 수 있다. 모든 트랜잭션이 추가 리다이렉트 단계를 포함하게 된다. 또한 반드시 첫번째 웹 서버가 요청 부하를 다룰 수 있어야한다.                                        |
| DNS 리다이렉션        | DNS서버가 URL의 호스트 명에 대한 응답으로 어떤 IP 주소를 사용할지 결정한다.                                                                                                                                    | 라운드로빈 부하 균형, 회전지연 최소화, 최단거리 선정 등의 여러옵션.        | DNS 서버를 설정할 필요가 있다.                                                                                                                                          |
| 임의 캐스트 어드레싱  | 어려 서버가 같은 IP 주소를 사용한다. 각 서버는 백본 라우터인 척 한다. 그 외의 라우터들은 그 공유된 IP주소로 향하는 패킷을 가장 가까운 서버로 보낸다.                                                           | 라우터들은 내장된 최단거리 라우팅 기능을 사용한다.                         | 라우터를 갖고 설정할 필요가 있다. 주소가 충돌할 위험이 있다. 만약 라우팅이 바뀌고 커넥션과 연관된 패킷들이 다른 서버들로 보내진다면 수립된 TCP 커낵션이 깨질 수도 있다. |
| 아이피 맥(MAC) 포워딩 | 스위치나 라우터 같은 네트워크 요소가 패킷의 목적지 주소를 읽는다. 만약 패킷이 리다이렉트되어야 한다면, 스위치는 그 패킷에게 서버나 프락시의 목적지 MAC 주소를 준다.                                            | 대역폭을 절약하고 QOS(Quality of Service) 서비스 품질을 개선한다. 부하균형 | 서버나 프락시는 반드시 한 홉 거리에 있어야 한다.                                                                                                                        |
| IP 주소 포워딩        | 레이어4(L4) 스위치는 패킷의 목적지 포트를 평가하고, 리다이렉트 패킷의 아이피 주소를 프락시나 미러링된 서버의 아이피 주소로 바꾼다.                                                                             | 대역폭을 절약하고 QOS를 개선한다. 부하균형                                 | 서버나 프락시가 클라이언트의 IP 주소를 잃어버릴 수 있다.                                                                                                                |

## 20.4 일반적인 리다이렉션 방법

### 20.4.1 HTTP 리다이렉션

웹 서버들은 다른 곳에 요청을 보내보라고 말해주는 짧은 리다이렉트 메세지를 클라이언트에게 돌려줄 수 있다. 몇몇 웹사이트는 HTTP 리다이렉션을 이용해 간단하게 부하를 분산한다. 요청을 처리하는 서버(리다이렉팅 서버)는 가용한 것들 중 부하가 가장 적은 컨텐츠 서버를 찾아서 브라우저의 요청을 그 서버로 리다이렉트한다.

- **HTTP 리다이렉션이 갖는 장점**
  - 리다이렉트를 하는 서버가 클라이언트의 아이피 주소를 안다.
    → 주소를 알면 좀 더 정보에 근거하여 선택할 수 있다.
- **HTTP 리다이렉션이 갖는 단점**
  - 어떤 서버로 리다이렉트 할지 결정하려면 원 서버는 상당히 많은 처리를 해야한다. 때로는 거의 페이지 자체를 제공할 때 필요한 것과 같은 양의 처리가 필요하다.
  - 페이지에 접근할 때마다 두번의 왕복이 필요하기 때문에 사용자가 더 오래 기다리게 된다.
  - 만약 리다이렉트 서버가 고장나면 사이트도 고장난다.
  → 이러한 약점 때문에 HTTP 리다이렉션은 보통 다른 리다이렉션 기법과 함께 조합하여 사용된다.

### 20.4.2 DNS 리다이렉션

DNS 분석자는 클라이언트의 운영체제일 수도 있고, 클라이언트의 네트워크에 있는 DNS 서버이거나 더 원격ㄹ에 있는 DNS 서버일 수도 있다.

DNS는 하나의 도메인에 여러 아이피 주소가 결부되는 것을 허용하며, DNS 분석자는 여러 아이피 주소를 반환하도록 설정되거나 프로그래밍 될 수 있다. DNS 분석자는 어떤 아이피 주소를 반환할 것인지 단순한(라운드 로빈이 가장 쉬운 DNS 결정 알고리즘) 방법과 복잡한 방법이 있다.

- **DNS 라운드로빈**
  - 가장 흔한 동시에 가장 단순한 리다이렉션 기법. 웹 서버 팜 전체에 대한 부하의 균형 유지를 위해 DNS 호스트명 분석 기능을 사용한다.
- **다중 주소와 라운드로빈 주소 순환**
  - 대부분의 DNS 클라이언트는 그냥 다중 주소 집합의 첫번째 주소를 사용한다. 부하 균형을 위해 대부분의 DNS 서버는 룩업이 끝났을 때마다 주소를 순환시킨다. 이 주소 순환을 DNS 라운드 로빈이라 부르기도한다.
- **부하 균형을 위한 DNS 라운드 로빈**
  - 대부분의 DNS클라이언트는 그냥 첫 번째 주소를 사용하기 때문에, DNS 순환은 서버들 간의 부하균형을 유지해준다. 만약 DNS가 주소를 순환시키지 않는다면, 대부분의 클라이언트가 목록의 첫번째 서버를 선택할 것이고 그 서버가 대부분의 부하를 받게될 것이다.
- **DNS 캐싱의 효과**
  - DNS 주소 순환은 부하를 순환시킨다. 왜냐하면 서버에 대한 각 DNS 룩업은 서버 주소를 다른 순서로 가져오기 때문이다. 그러나 이 부하 균형은 완벽하지 않은데, DNS 룩업의 결과는 애플리케이션, 운영체제, 몇몇 기초적인 자식 DNS 서버에 의해 기억되어 재사용될 수 있기 때문이다.
    호스트 하나에 대해 한 번의 DNS 룩업을 수행한뒤, 그 주소를 몇번이고 다시 사용한다. 그렇게 하면 DNS 룩업의 비용을 줄일 수 있을 뿐 아니라 같은 클라이언트와 계속 대화하는 것을 선호하는 서버들도 있기 때문이다. 이러한 이유로 DNS 라운드로빈은 일반적으로 하나의 클라이언트로 인한 부하를 제대로 분한하지 못한다.
    그러나 비록 DNS가 단일 클라이언트의 트랜잭션을 서버의 복제들에게 나눠주지는 않더라도, 그것은 여러 클라이언트의 부하 총량을 분산하는 적절한 작업을 수행한다. 비슷한 요청을 하는 클라이언트 수의 어느정도 이상만 된다면 부하는 모든 서버에 걸쳐 상대적으로 잘 분산될 것이다.
- **다른 DNS 기반 리다이렉션 알고리즘**
  - 부하 균형 알고리즘
    - 몇몇 DNS 서버는 웹 서버의 로드를 추적하고 가장 로드가 적은 우베 서버를 목록의 가장 위에 놓는다.
  - 근접 라우팅 알고리즘
    - 웹 서버들의 팜이 지리적으로 분산되어 있는 경우, DNS 서버는 사용자를 근처의 웹서버로 보내는 시도를 할 수 있다.
  - 결함 마스킹 알고리즘
    - DNS 서버는 네트워크의 건강상태를 모니터링하고 요청을 정전이나 기타 장애를 피해서 라우팅 할 수 있다.

### 20.4.3 임의 캐스트 어드레싱

임의 캐스트 어드레싱은 **하나의 IP 주소를 여러 서버가 공유하고, 네트워크 라우팅에 따라 가장 적합한 서버가 선택되어 통신이 이루어지는 방식이다.**

- DNS 루트 서버는 전 세계 여러 곳에 동일한 Anycast IP를 두어, 사용자가 가장 가까운 서버와 통신하게 함.
- CDN(Content Delivery Network)도 이 방식을 활용해 사용자 요청을 최적의 엣지 서버로 분산시킴.

### 20.4.4 아이피 맥 포워딩

- 네트워크 통신은 IP 주소(논리적 주소)와 MAC 주소(물리적 주소)를 기반으로 동작합니다.
- 패킷이 목적지 IP를 향해 전달될 때, 실제 전송 단계에서는 **ARP(Address Resolution Protocol)** 등을 이용해 해당 IP에 대응되는 MAC 주소를 찾고, 이 MAC 주소를 이용해 스위치가 해당 장치(서버, PC 등)로 패킷을 포워딩합니다.
- 즉, **IP–MAC 포워딩은 IP–MAC 매핑을 바탕으로 스위치가 올바른 포트로 패킷을 전달하는 과정**입니다.
- **서버/프락시와 스위치의 물리적 위치**
  - 서버나 프락시(Proxy)는 **클라이언트의 요청을 직접 받아 처리하거나 중계**하는 역할을 합니다. 이때 **스위치와 한 홉(hop) 거리**에 위치해야 하는 이유는
    **지연 최소화**: 불필요한 라우팅 장비(추가 홉)를 거치지 않고, 바로 스위치–서버 간 연결이 되어야 빠른 응답이 가능합니다.
    **MAC 기반 포워딩 구조**: 스위치는 동작 원리상 **MAC 주소 단위**로 포워딩하기 때문에, 서버나 프락시가 스위치에 직접 연결되어 있어야 올바른 MAC 학습과 ARP 매핑이 가능합니다.
    **보안/정합성**: 서버가 멀리 떨어져 여러 홉을 거치면 IP–MAC 매핑이 복잡해지고, 중간 구간에서 스푸핑(spoofing)이나 패킷 손실 문제가 발생할 수 있습니다.

### 20.4.5 아이피 주소 포워딩

**IP 주소 포워딩**은 패킷을 **목적지 MAC이 아닌 목적지 IP 주소 기준**으로 라우팅하는 방식이다. 이 과정은 NAT(Network Address Translation)의 일종으로 볼 수 있다.

- **장점:** 목적지 서버가 스위치와 **한 홉 거리에 있을 필요가 없고**, 단지 스위치가 업스트림 경로만 알면 일반적인 L3 라우팅으로 전달 가능하다.
- **단점: 라우팅 대칭성 문제**가 발생한다. 클라이언트와 맺은 TCP 커넥션은 스위치가 관리하기 때문에, 서버/프락시에서 나가는 응답도 반드시 같은 스위치를 거쳐 클라이언트로 돌아와야 한다.

**응답의 귀환 경로를 제어할수 있는 두가지 방법**

1. 패킷의 출발지 아이피 주소를 스위치의 아이피 주소로 바꾼다. 이 방법은 스위치와 서버 사이의 네트워크 설정이 어떤가와는 관계없이, 응답 패킷을 스위치로 가게한다. 이 목적지와 출발지 아이피 주소 양쪽을 번역해주는 아이피 전달 장치를 완전 NAT이라고 한다.
2. 만약 출발지 아이피 주소가 그 클라이언트의 아이피 주소로 계속 남아있다면 서버에서 클라이언트로 바로 가는 경로가 존재하지 않아야한다. 이는 때때로 반(half) NAT 이라고 불린다. 여기서 장점은 서버가 클라이언트 아이피 주소를 얻는다는 것이며, 단점은 클라이언트와 서버 사이의 네트워크 전체에 약간의 통제가 필요하다는 것이다.

### 20.4.6 네트워크 구성요소 제어 프로토콜

네트워크 구성요소 제어 프로토콜(Network Element Control Protocol, NECP)은 아이피 패킷을 전달하는 라우터나 스위치 같은 네트워크 구성요소들(NE)이 웹 서버나 프락시 캐시와 같이 애플리케이션 계층 요청을 처리한느 서버 구성요소들(SE)과 대화할 수 있게 해준다. NECP는 부하 균형을 명시적으로 지원하지는 않는다.

다만 SE는 NE에게 부하균형 정보를 제공할 수 있는 방법을 제공하여, SE가 적합하다고 판단한 대로 NE가 부하균형을 유지할 수 있게 한다. WCCP와 마찬가지로, NECP는 MAC 포워딩, GRE 캡슐화, NAT와 같은 패킷을 전달하는 여러 방법을 제공한다.

## 20.5 프락시 리다이렉션 방법

### 20.5.1 명시적 브라우저 설정

- 프락시들을 사용하도록 설정된 브라우저들은 프락시가 응답하지 않더라도 원서버와 접촉하지 않는다. 만약 프락시가 다운되었거나 브라우저가 잘못 설정되었다면 사용자는 접속 문제를 경험할 것이다.
- 네트워크 아키텍처를 변경했을 때 그 변경사항을 모든 최종 사용자에게 전파하는 것이 어렵다. 만약 서비스 제공자가 더 많은 프락시를 추가하길 원하거나 몇개를 서비스에서 제거하길 원한다면, 브라우저 사용자들은 그들의 프락시 설정을 변경해야만 할것이다.

### 20.5.2 프락시 자동 설정

**프락시 자동 설정(PAC)의 개념**

- **프락시 자동 설정**은 웹 브라우저나 클라이언트 애플리케이션이 네트워크 요청을 보낼 때, 어떤 프락시 서버를 사용할지 **자동으로 결정**해주는 메커니즘입니다.
- 보통 **PAC 파일(Proxy Auto-Config file)** 이라는 자바스크립트 스크립트를 이용하며, 이 파일은 URL·호스트명·IP 주소 등의 조건에 따라 프락시 사용 여부와 경로를 동적으로 지정합니다.
- **동작 방식**
  1. 클라이언트(브라우저 등)는 네트워크 설정에서 **PAC 파일 URL**을 지정받음.
  2. 해당 PAC 파일에는 `FindProxyForURL(url, host)` 함수가 정의되어 있음.
  3. 클라이언트가 특정 요청을 보낼 때 이 함수가 실행되어,
     1. 어떤 프락시 서버를 사용할지(`PROXY proxy.example.com:8080`)
     2. 혹은 직접 연결할지(`DIRECT`) 를 반환함.
  4. 그 결과에 따라 클라이언트는 요청을 프락시 경유 또는 직접 서버로 전송
- **장점**
  - **유연성**: 요청 대상 도메인·URL·IP 대역에 따라 프락시 사용 여부를 다르게 지정 가능.
  - **중앙 관리**: PAC 파일만 업데이트하면 모든 클라이언트에 일괄 적용 가능.
  - **보안/정책 적용**: 내부망과 외부망을 구분하거나 특정 사이트만 프락시를 타도록 설정할 수 있음.

### 20.5.3 웹 프락시 자동발견 프로토콜 (Web Proxy Autodiscovery Protocol)

- **WPAD**는 클라이언트(웹 브라우저 등)가 프락시 자동 설정 파일(PAC 파일)의 위치를 **자동으로 찾아서** 사용할 수 있도록 해주는 프로토콜입니다.
- 즉, 사용자가 일일이 프락시 서버 주소나 PAC 파일 경로를 입력하지 않아도, 네트워크 환경에 맞춰 자동으로 프락시를 설정할 수 있게 해줍니다.
- **동작 원리**
  - 클라이언트는 PAC 파일(`wpad.dat`)을 찾기 위해 **여러 방식**을 순차적으로 시도합니다. 대표적으로:
  1. **DHCP 옵션 사용**
     - DHCP 서버가 PAC 파일 URL을 클라이언트에게 전달.
  2. **DNS 기반 탐색**
     - 클라이언트가 `wpad.<도메인>` 형태의 DNS 이름을 순차적으로 조회.
     - 예: 클라이언트가 `client.branch.company.com`에 있으면 →
       `wpad.branch.company.com` → `wpad.company.com` 순으로 PAC 파일 위치 확인.
  3. **HTTP 요청**
     - 찾은 호스트에서 `http://wpad.<domain>/wpad.dat` 파일을 가져옴.
- **장점**
  - **자동화**: 프락시 환경이 바뀌어도 사용자가 직접 수정할 필요 없음.
  - **중앙 관리 용이**: 네트워크 관리자 입장에서 PAC 파일만 배포·갱신하면 됨.
  - **유연성**: 사무실/외부 네트워크 등 접속 위치에 따라 자동으로 알맞은 프락시 적용.
- **보안 이슈**
  - **DNS 스푸핑 위험**: 공격자가 `wpad` 도메인을 탈취하거나 위조하면 악성 PAC 파일을 배포 가능.
  - **MitM(중간자 공격) 가능성**: 클라이언트 트래픽을 악성 프락시로 유도할 수 있음.
  - 그래서 최근에는 보안 이유로 WPAD를 비활성화하거나, 내부 DNS·DHCP에서만 제한적으로 사용.
- **WPAD 알고리즘 절차**
  클라이언트(브라우저 등)는 아래 단계들을 순차적으로 시도합니다:
  1. **DHCP 탐색**
     - 먼저 DHCP 서버에 WPAD 옵션(옵션 252)을 질의합니다.
     - DHCP 서버가 PAC 파일의 URL을 응답해주면, 해당 위치에서 PAC 파일을 다운로드합니다.
  2. **DNS 기반 탐색**

     DHCP에서 응답이 없거나 실패하면, DNS를 사용하여 PAC 파일을 찾습니다.

     - 클라이언트는 자신의 도메인 이름을 기준으로 **점차 축소된 도메인**에 대해 `wpad.<domain>` 호스트명을 질의합니다.
     - 예시: 클라이언트의 FQDN이 `client.branch.office.company.com` 이라면 다음 순서로 탐색합니다
       1. `wpad.branch.office.company.com`
       2. `wpad.office.company.com`
       3. `wpad.company.com`
     - DNS가 응답하면, 해당 호스트에 `http://wpad.<domain>/wpad.dat` 요청을 보냅니다.

  3. **PAC 파일 다운로드 및 실행**
     - 찾은 `wpad.dat` 파일을 내려받아 내부의 JavaScript 함수 `FindProxyForURL(url, host)`를 실행합니다.
     - 이 함수의 반환값(`DIRECT`, `PROXY proxy.example.com:8080` 등)에 따라 트래픽을 처리합니다.

## 20.6 캐시 리다이렉션 방법

### 20.6.1 WCCP 리다이렉션

- **WCCP 리다이렉션 동작**
  - 네트워크가 필요하다. 이 네트워크에는 WCCP를 사용할 수 있는 라우터와 다른 캐시와 소통할 수 있는 캐시가 포함되어야 한다.
  - 라우터들의 집합과 그들의 대상이 되는 캐시들이 WCCP 서비스 그룹을 구성한다. 서비스 그룹의 설정은 어떤 트래픽이 어디로 어떻게 보내지는지, 그리고 서비스 그룹에서 부하가 캐시들 사이에서 어떻게 분산되어야 하는지 명시한다.
  - 만약 서비스 그룹이 HTTP 트래픽을 리다이렉션하도록 설정되어 있다면, 서비스 그룹의 라우터는 HTTP 요청을 서비스 그룹의 캐시로 보낸다
  - HTTP 요청이 서비스 그룹의 라우터에 도착했을 때, 라우터는 그 요청을 처리하기 위해 서비스 그룹의 캐시 중 하나를 선택한다.
  - 라우터는 요청 패킷을 캐시의 아이피 주소와 함께 캡슐화 하거나 아이피 맥 포워딩을 하여 캐시로 보낸다.
  - 만약 캐시가 요청을 처리할 수 없다면 패킷은 평범하게 포워딩 되기 위해 라우터로 돌아온다.
  - 서비스 그룹의 구성원들은 지속적으로 다른 구성원들의 가용성을 확인하기 위해 하트비트 메세지를 교환한다.
- **메세지 구성요소**
  - 각 WCCP2 메세지는 헤더와 구성요소로 구성되어있다. WCCP 헤더 정보는 메세지의 종류, WCCP버전, 메세지의 길이를 포함한다.
- **서비스 그룹**
  - 서비스 그룹은 WCCP를 지원하는, 그래서 WCCP 메세지를 교환할 수 있는 라우터와 캐시들의 집합으로 구성되어있다. 이 라우터들은 웹 트래픽을 서비스그룹의 캐시로 보낸다. 서비스 그룹의 설정으 ㄴ어떻게 트래픽이 이 서비스 그룹의 캐시들로 분산되는지 결정한다.
- **GRE 패킷 캡슐화**
  - WCCP를 지원하는 라우터들은 HTTP 패킷을 특정 서버의 IP 주소와 함께 캡슐화 함으로 써 그 서버들로 리다이렉트한다. 이 패킷 캡슐화는 일반 라우터 캡슐화임을 나타내는 IP헤더 proto 필드로 포함하고 있다. proto 필드의 존재는 수신 측 프락시에게 그 패킷이 캡슐화된 패킷을 갖고있음을 말해준다. 패킷이 캡슐화 되어 있기 때문에 클라이언트 아이피 주소를 잃어버리지 않는다.
- **WCCP 부하균형**
  - WCCP 라우터는 라우팅 뿐만 아니라 여러 수신 서버간의 부하균형을 유지할 수 있다. WCCP 라우터와 그들의 수신 서버들은 그들이 살아있고 동작중임을 다른 장비들이 알 수 있도록 하트비트 메세지를 서로 교환한다. 만약 특정 수신 서버가 하트비트 메세지를 보내지 않게 되었다면, WCCP 라우터는 트래픽 요청을 그 노드로 리다이렉트 하는 대신 인터넷으로 바로 보낸다. 노드가 다시 정상화되면 WCCP 라우터는 다시 하트비트 메세지를 받고 그 노드로 요청 트래픽을 보내기 시작한다.

## 20.7 인터넷 캐시 프로토콜

- **OP 코드** (Operation code): 메시지의 종류(요청, 응답, 조회·결과·에러 등)를 나타내는 식별자. 8비트값
- **버전** (Version): 프로토콜 규약의 버전 번호.
- **메시지 길이** (Message length): ICP 메세지의 총 길이를 바이트 단위로 나타낸 것
- **요청번호:** ICP를 지원하는 캐시는 동시에 여러 요청과 응답을 추적하기 위해 요청번호를 사용한다.
- **옵션 (Options)**: 32비트 ICP 옵션 필드는 ICP의 동작을 변경하는 플래그를 담고있는 비트 벡터이다.
- **옵션 데이터 (Option data):** 각 옵션이 필요로 하는 구체적 값(예: 특정 옵션의 파라미터).
- **발송자 호스트 주소 (Sender host address):** 메세지 발송자의 32비트 아이피 주소를 담고있는 필드
- **페이로드 (Payload):** 실제 전달하고자 하는 데이터 본문(예: 요청 URL, 객체 식별자, 상태 정보 등).

## 20.8 캐시 배열 라우팅 프로토콜

캐시 배열 라우팅 프로토콜(CARP)는 프락시 서버의 배열이 클라이언트의 시점에서는 마치 하나의 논리적인 캐시처럼 보이도록 과닐해주는 표준이다.

CARP는 ICP의 대안이다. CARP와 ICP둘 다 관리자가 여러대의 프락시 서버를 사용하여 성능을 개선할 수 있게 해준다.

- 실제 적용 사례
  - 프록시 캐시 클러스터(Squid 등) 및 CDN 엣지 노드의 요청 분배에 활용.
  - 일관성 해싱/HRW 기반 라우팅을 도입하면 노드 churn(교체/증설) 시 서비스 영향 최소화 가능.
- **동작 원리(간단 알고리즘)**
  1. 클라이언트 요청에서 **키(예: URL)**를 추출.
  2. 키에 대해 **해시 함수**를 계산(예: SHA1, MD5 등).
  3. 해시 결과를 노드 수나 해시 링에 매핑하여 **대상 캐시 노드**를 결정.
     - 단순 구현: `index = hash(url) mod N`
     - 고급 구현: **일관성 해싱(consistent hashing)** 또는 HRW(Highest Random Weight) 사용 → 노드 변동 시 재배치 최소화.
  4. 선정된 노드로 요청을 포워딩. 해당 노드가 MISS면 다른 노드(또는 원서버)로 처리하거나 라우팅 룰에 따라 재시도.

## 20.9 하이퍼텍스트 캐싱 프로토콜

형제들이 URL과 모든 요청 및 응답 헤더를 사용하여 서로에게 문서의 존재 여부에 대한 질의를 할 수 있도록 해줌으로써 적중이 아님에도 적중으로 잘못 처리될 확률을 줄인다. 더 나아가 HTCP는 형제 캐시들이 서로의 캐시 안에 있는 선택된 문서의 추가 및 삭제를 모니터링하고 요청할 수 있게, 그리고 서로의 캐시된 문서에 대한 캐싱 정책을 변경할 수 있게 해준다.

헤더 부분은 메세지의 길이와 메세지의 버전을 포함한다. 데이터 부분은 OP 코드를 포함한 데이터의 길이로 시작하여, 응답 코드, 몇몇 태그들과 아이디들이 이어지며 실제 데이터로 끝난다.

### 20.9.1 HTCP 인증

HTCP 메세지의 인증 부분은 선택적이다.

### 20.9.2 캐싱 정책 설정

SET 메세지는 캐시가 캐시된 문서에 대한 정책 변경을 요청할 수 있게 해준다.

요청과 응답 헤더를 질의 메세지에 담아 형제 캐시로 보내는 것이 허용됨에 따라, HTCP는 캐시 질의에서 거짓 적중의 비율을 줄일 수 있다. 더 나아가 HTCP는 형제 캐시들이 정책 정보를 서로 교환할 수 있게 함으로써 그들이 더욱 서로를 잘 도울 수 있게 해줄 수 있다.
