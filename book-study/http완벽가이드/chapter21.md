# 21. 로깅과 사용 추적

거의 모든 서버와 프락시는 처리했던 HTTP 트랜잭션을 요약해서 기록해 놓는다. 사용 추적, 보안, 청구, 에러 탐지 등등을 위함이다.

## 21.1 로그란 무엇인가?

서버나 프락시의 문제를 찾거나 웹사이트 접근 통계를 낼 때 보통 로깅을 한다. 이는 서버나 대역폭을 늘릴 필요가 있는지 계획을 세우는데 유용하다.

HTTP 트랜잭션의 모든 헤더를 로깅하면 너무 방대한 양과 필요없는 내용도 포함되기 때문에 아래와 같은 기본 항목들만 로깅한다.

- **로깅하는 필드**
  - **HTTP 메서드**
    - 어떤 요청인지 알 수 있음
  - **클라이언트와 서버의 HTTP 버전**
    - 클라-서버 간의 문제가 발생되었을때 디버깅하는데 정보 제공
  - **요청받은 리소스의 URL**
    - 웹사이트 특정 페이지가 얼마나 인기있는지 추적하는데 사용 가능
  - **응답의 HTTP 상태코드**
    - 요청 상태에 대한 정보
  - **요청과 응답 메세지의 크기(모든 엔터티 본문을 포함)**
    - 계측하는데 사용
  - **트랜잭션이 일어난 시간**
    - 문제 발생 시 시간 추적
  - **Referer와 User-Agent 헤더 값**

## 21.2 로그 포맷

상용, 오픈쏘스 HTTP 어플리케이션은 대부분은 표준 로그 포맷을 한개 이상 지원한다. 그리고 대부분 로그 포맷을 설정하고 자체 포맷을 만들 수 있도록 설정도 제공한다.

### 21.2.1 일반 로그 포맷 (Common Log Format)

본래 NCSA가 정의하였고 많은 서버가 이 로그 포맷을 기본으로 사용함.

| 필드                                                                                                | 설명                                                      |
| --------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| remotehost                                                                                          | 요청한 컴퓨터의 호스트명 혹은 IP 주소                     |
| (서버가 리버스 DNS를 수행하게 설정되어있지 않거나 요청자의 호스트명을 찾을 수 없으면 IP를 기술한다) |
| username                                                                                            | ident 검색을 수했다면, 인증된 요청자의 사용자이름이 있다. |
| auth-username                                                                                       | 인증을 수행했다면 인증된 요청자의 이름이 있다.            |
| thimestamp                                                                                          | 요청된 날짜와 시간                                        |
| request-line                                                                                        | HTTP 요청의 행을 그대로 기술한다.                         |
| response-code                                                                                       | 응답으로 보내는 HTTP 상태코드                             |
| response-size                                                                                       | 응답 엔터티의 Content-Length.                             |
| 응답으로 아무런 엔터티도 반환하지 않으면 값이 0이된다.                                              |

### 21.2.2 혼합 로그 포맷 (Combined Log Format)

아파치같은 서버들이 지원하며 일반 로그 포맷과 매우 유사하다.

추가된 필드 두개를 제외하면 똑같음.

- Referer: Referer HTTP 헤더의 값
- User-Agent: User-Agent Referer HTTP 헤더의 값

### 21.2.3 넷스케이프 확장 로그 포맷

NCSA 일반 로그 포맷에서 시작했지만 프락시나 웹캐시같은 HTTP 어플리케이션과 연관있는 여러 환경을 지원하려고 포맷을 확장함

| **필드**                 | **설명**                                                                                      |
| ------------------------ | --------------------------------------------------------------------------------------------- |
| proxy-response-code      | 트랜잭션이 프락시를 거칠 경우, 서버에서 프락시로의 HTTP 응답코드                              |
| proxy-response-size      | 트랜잭션이 프락시를 거칠 경우, 서버가 프락시에 전달하는 으답 엔터티의 Content-Length          |
| client-request-size      | 클라이언트가 프락시로 보내는 요청의 본문이나 엔터티의 Content-Length                          |
| proxy-request-size       | 트랜잭션이 프락시를 거칠 경우, 프락시가 서버로 보내는 요청의 본문이나 엔터티의 Content-Length |
| client-request-hdr-size  | 클라이언트 요청 헤더의 바이트 길이                                                            |
| proxy-response-hdr-size  | 트랜잭션이 프락시를 거칠 경우, 프락시가 요청자에게 보내는 응답헤더의 바이트 길이              |
| proxy-request-hdr-size   | 트랜잭션이 프락시를 거칠 경우, 프락시가 서버로 전송하는 요청 헤더의 바이트 길이               |
| server-response-hdr-size | 서버 응답 헤더의 바이트 길이                                                                  |
| proxy-timestamp          | 트랜잭션이 프락시를 거칠 경우, 요청과 응답이 프락시를 통해 오가는 총 시간( 초단위)            |

### 21.2.4 넷스케이프 확장 2 로그 포맷

확장된 로그 포맷

- route
  - 프락시가 클라이언트에 요청을 만드는데 사용하는 경로
- client-finish-status-code
  - 클라이언트의 종료 상태 코드로, 클라이언트가 프락시로 보낸 요청이 성공적으로 완료 되었는지 혹은 인터럽트에 걸렸는지 기술
- proxy-finish-status-code
  - 프락시의 종료 샅태 코드로, 프락시가 서버로 보낸 요청이 성공정그로 완료되었는지 혹은 인터럽트에 걸렸는지 기술
- cache-result-code
  - 캐시 결과 코드로 캐시가 요청에 어떻게 응답했는지 기술

### 21.2.5 스퀴드(Squid) 프락시 로그 포맷

웹 분야에서 권이있는 프로젝트. 스퀴드는 수년간 오픈소스 커뮤니티를 통해 확장 및 개선된 프로젝트이며, 스퀴드 어플리케이션ㅇ 관리하는데 도움이 되는 수많은 도구들이 개발됨.

## 21.3 적중 계량하기

적중계량(Hit Metering) 규약은 HTTP의 확장으로, 그 문제의 해결책으로 제시됨. 적중 계량 규약에서는 캐시가 정기적으로 캐시 접근 통계를 원 서버에 보고하도록한다.

### 21.3.1 개요

적중 계량 규약은 캐시와 서버가 접근 정보를 공유하고 사용할 수 있는 캐시 리소스의 양을 제어할 수 있는 몇가지 기초적인 기능에 관한 HTTP 확장을 정의한다.

### 21.3.2 Meter 헤더

Meter라는 새로운 헤더를 추가하여 Cache-Control 헤더에 다양한 캐시 지시자를 기술할 수 있듯이, 캐시나 서버는 Meter 헤더에 사용량이나 보고에 관한 지시자가 기술할 수 있다.

## 21.4 개인 정보 보호에 대해

로깅은 관리자와 개발자에게 매우 유용한 도구이지만 로깅을 당하는 사람들의 인지나 허가가 없으면 로깅이 사생활 침해가 된다는것을 유념해야한다.

로깅을 하는 웹 서버와 프락시는 최종 사용자의 개인 정보를 보호하는데 시녁ㅇ을 많이 써야한다.
